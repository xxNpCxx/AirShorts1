import { Context } from "telegraf";
import { KeyboardsService } from "../keyboards/keyboards.service";
import { CustomLoggerService } from "../logger/logger.service";

/**
 * –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ö –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
 */
export class MainMenuHandler {
  private static kbService = new KeyboardsService();
  private static loggerService = new CustomLoggerService();

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–º –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
   */
  static isMainMenuMessage(text: string): boolean {
    const mainMenuMessages = ["üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"];
    return mainMenuMessages.includes(text);
  }

  /**
   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
   * –í—ã—Ö–æ–¥–∏—Ç –∏–∑ —Å—Ü–µ–Ω—ã (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
   */
  static async handleMainMenuRequest(ctx: Context, source: string = "unknown"): Promise<void> {
    try {
      this.loggerService.debug(
        `üè† [${source}] –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${ctx.from?.id}`,
        "MainMenuHandler"
      );

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å—Ü–µ–Ω–µ
      const sceneContext = ctx as unknown as {
        scene: { 
          current?: { id: string };
          leave: () => Promise<void>;
        };
      };
      
      if (sceneContext.scene?.current) {
        this.loggerService.debug(
          `üö™ –í—ã—Ö–æ–¥–∏–º –∏–∑ —Å—Ü–µ–Ω—ã "${sceneContext.scene.current.id}" –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${ctx.from?.id}`,
          "MainMenuHandler"
        );
        await sceneContext.scene.leave();
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
      await this.showMainMenu(ctx);
      
      this.loggerService.debug(
        `‚úÖ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —É—Å–ø–µ—à–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${ctx.from?.id}`,
        "MainMenuHandler"
      );
    } catch (error) {
      this.loggerService.error(
        `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é: ${error}`,
        undefined,
        "MainMenuHandler"
      );
      throw error;
    }
  }

  /**
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   */
  static async showMainMenu(ctx: Context): Promise<void> {
    try {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
      await ctx.reply(
        "üé¨ –ì–ï–ù–ï–†–ê–¢–û–† –í–ò–î–ï–û\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–µ–æ!\n\n‚ú® –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ\nüé≠ 3D –∞–≤–∞—Ç–∞—Ä—ã —Å –≤–∞—à–∏–º –≥–æ–ª–æ—Å–æ–º\nüì± –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ä–æ–ª–∏–∫–æ–≤\nüöÄ –ë—ã—Å—Ç—Ä–∞—è –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è",
        {
          reply_markup: this.kbService.mainInline().reply_markup,
        }
      );

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –æ—Ç–¥–µ–ª—å–Ω–æ
      await ctx.reply("üé¨", {
        reply_markup: this.kbService.mainReply().reply_markup,
      });

      this.loggerService.debug(
        `–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${ctx.from?.id}`,
        "MainMenuHandler"
      );
    } catch (error) {
      this.loggerService.error(
        `–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é: ${error}`,
        undefined,
        "MainMenuHandler"
      );
      throw error;
    }
  }
}
